<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lua File Encryptor</title>
</head>
<body>
    <h1>Lua File Encryptor</h1>
    <input type="file" id="fileInput">
    <input type="password" id="passwordInput" placeholder="Enter password">
    <button onclick="encryptFile()">Encrypt</button>
    <a id="downloadLink" style="display: none;">Download Encrypted File</a>

    <script>
        async function encryptFile() {
            const fileInput = document.getElementById('fileInput');
            const passwordInput = document.getElementById('passwordInput');
            const downloadLink = document.getElementById('downloadLink');

            if (fileInput.files.length === 0) {
                alert("Please select a file.");
                return;
            }

            if (!passwordInput.value) {
                alert("Please enter a password.");
                return;
            }

            const file = fileInput.files[0];
            const password = passwordInput.value;

            const reader = new FileReader();
            reader.onload = async function(event) {
                const fileData = event.target.result;

                const encryptedData = await encryptData(fileData, password);
                
                const blob = new Blob([encryptedData], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);

                downloadLink.href = url;
                downloadLink.download = file.name + '.encrypted';
                downloadLink.style.display = 'block';
                downloadLink.innerText = 'Download Encrypted File';
            };
            reader.readAsArrayBuffer(file);
        }

        async function encryptData(data, password) {
            const enc = new TextEncoder();
            const keyMaterial = await getKeyMaterial(password);
            const key = await getKey(keyMaterial);

            const iv = window.crypto.getRandomValues(new Uint8Array(16));
            const algorithm = {
                name: "AES-CBC",
                iv: iv
            };

            const encrypted = await window.crypto.subtle.encrypt(algorithm, key, data);

            const encryptedData = new Uint8Array(iv.byteLength + encrypted.byteLength);
            encryptedData.set(iv);
            encryptedData.set(new Uint8Array(encrypted), iv.byteLength);

            return encryptedData;
        }

        async function getKeyMaterial(password) {
            const enc = new TextEncoder();
            return window.crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                { name: "PBKDF2" },
                false,
                ["deriveBits", "deriveKey"]
            );
        }

        async function getKey(keyMaterial) {
            return window.crypto.subtle.deriveKey(
                {
                    "name": "PBKDF2",
                    salt: window.crypto.getRandomValues(new Uint8Array(16)),
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { "name": "AES-CBC", "length": 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }
    </script>
</body>
</html>
